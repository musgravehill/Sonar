<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>My first three.js app</title>
        <style>
            body { margin: 0; }
        </style>
    </head>
    <body>
        <div id="container"></div>
        <script src="three.js"></script>
        <script>

            let container, stats;
            let camera, controls, scene, renderer;
            let mesh, texture;

            const worldWidth = 256, worldDepth = 256;


            init();
            //animate();
            function init() {
                container = document.getElementById('container');

                camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 0.1, 10000);

                scene = new THREE.Scene();
                //scene.background = new THREE.Color(0xefd1b5);
                //scene.fog = new THREE.FogExp2(0xefd1b5, 0.0025);



                //camera.position.set(100, 100, -800);
                //camera.lookAt(-100, 110, -100);
                camera.position.z = 800;

                /*const data = generateHeight(worldWidth, worldDepth);
                 //const geometry = new THREE.PlaneGeometry(7500, 7500, worldWidth - 1, worldDepth - 1);
                 //geometry.rotateX(-Math.PI / 2);
                 const geometry = new THREE.PlaneGeometry(7500, 7500, worldWidth - 1, worldDepth - 1);
                 
                 const vertices = geometry.attributes.position.array;
                 for (let i = 0, j = 0, l = vertices.length; i < l; i++, j += 3) {
                 vertices[ j + 1 ] = data[ i ] * 10;
                 }
                 
                 texture = new THREE.CanvasTexture(generateTextureRGB(data, worldWidth, worldDepth));
                 texture.wrapS = THREE.ClampToEdgeWrapping;
                 texture.wrapT = THREE.ClampToEdgeWrapping;
                 
                 mesh = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({map: texture}));
                 scene.add(mesh); */




                renderer = new THREE.WebGLRenderer();
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(renderer.domElement);


            }

            function generateHeight(width, height) {
                const size = width * height;
                const data = new Uint8Array(size);

                for (let j = 0; j < 4; j++) {
                    for (let i = 0; i < size; i++) {
                        data[i] += Math.abs(Math.random() * 10);
                    }
                }
                return data;
            }

            function render() {
                renderer.render(scene, camera);
            }

            function generateTextureRGB(zzzzdata, width, height) {
                const depth = 100;
                const size = width * height;
                const data = new Uint8Array(3 * size * depth);
                for (let i = 0; i < depth; i++) {
                    const color = new THREE.Color(Math.random(), Math.random(), Math.random());
                    const r = Math.floor(color.r * 255);
                    const g = Math.floor(color.g * 255);
                    const b = Math.floor(color.b * 255);
                    for (let j = 0; j < size; j++) {
                        const stride = (i * size + j) * 3;
                        data[ stride ] = r;
                        data[ stride + 1 ] = g;
                        data[ stride + 2 ] = b;
                    }
                }
                // used the buffer to create a DataTexture2DArray
                const texture = new THREE.DataTexture2DArray(data, width, height, depth);
                texture.format = THREE.RGBFormat;
                texture.type = THREE.UnsignedByteType;
            }

            function animate() {
                requestAnimationFrame(animate);
                render();
            }


            var img = new Image();
            img.onload = function () {

                const loader = new THREE.TextureLoader();
                loader.load(
                        'heightmap2.png',
                        function (texture) {
                            const material = new THREE.MeshBasicMaterial({
                                map: texture
                            });                            
                            var data = getHeightData(img);                               
                            //texture.wrapS = THREE.ClampToEdgeWrapping;?
                            //texture.wrapT = THREE.ClampToEdgeWrapping;?                                            
                            const geometry = new THREE.PlaneGeometry(worldWidth, worldDepth, worldWidth - 1, worldDepth - 1);
                            geometry.rotateX(-Math.PI / 6);
                            //const material = new THREE.MeshBasicMaterial({color: 0xffff00, side: THREE.DoubleSide});
                            const vertices = geometry.attributes.position.array;
                            for (let i = 0, j = 0, l = vertices.length; i < l; i++, j += 3) {
                                vertices[ j + 1 ] = Math.round(data[i] * 10);
                            }

                            const plane = new THREE.Mesh(geometry, material);

                            scene.add(plane);



                            //plane = new THREE.Mesh(geometry, material);
                            //set height of vertices
                            // const vertices = geometry.attributes.position.array;
                            //for (let i = 0, j = 0, l = vertices.length; i < l; i++, j += 3) {
                            // vertices[ j + 1 ] = Math.round(data[i] * 10);
                            //}
                            //scene.add(plane);

                            render();
                        },
                        undefined,
                        function (err) {
                            console.error('An error happened.');
                        }
                );





            };
            img.src = "heightmap2.png";

            function getHeightData(img, scale) {

                if (scale == undefined) {
                    scale = 1;
                }

                var canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                var context = canvas.getContext('2d');

                var size = img.width * img.height;
                var data = new Float32Array(size);

                context.drawImage(img, 0, 0);

                for (var i = 0; i < size; i++) {
                    data[i] = 0;
                }

                var imgd = context.getImageData(0, 0, img.width, img.height);
                var pix = imgd.data;

                var j = 0;
                for (var i = 0; i < pix.length; i += 4) {
                    var all = pix[i] + pix[i + 1] + pix[i + 2];
                    data[j++] = all / (12 * scale);
                }

                return data;
            }


        </script>
    </body>
</html>
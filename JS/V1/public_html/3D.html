<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="bootstrap.min.css" rel="stylesheet">
        <title>3D</title>
    </head>
    <body>
        <main class="container">
            <div class="row mt-2">
                <div class="col-2">
                    <div class="row">
                        <div class="col">
                            <h2>
                                3D 
                                <span id="bathymetry__points_count"></span>
                            </h2>
                        </div>                
                    </div>
                    <div class="row">                        
                        <div class="col-auto mb-1">
                            <div class="" style="width: 200px">
                                <div class="input-group">
                                    <span class="input-group-text" id="basic-addon1">Min depth, m</span>
                                    <input type="number" id="form_bathymetry__depth_min_input" placeholder="min" value="0.5" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-auto mb-1">
                            <div class="" style="width: 200px">
                                <div class="input-group">
                                    <span class="input-group-text" id="basic-addon1">max</span>
                                    <input type="number" id="form_bathymetry__depth_max_input" placeholder="max" value="5" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-auto mb-1">
                            <textarea id="form_bathymetry__data_input" class="form-control" style="width: 200px; height: 16px;" placeholder="Logic log"></textarea> 
                        </div>
                        <div class="col-auto mb-1">
                            <span id="form_bathymetry__btn_ok" class="btn btn-success">Ok</span>
                        </div>
                    </div> 
                </div> 
                <div class="col-10">
                    <div class="d-block">
                        <div id="sonar__palette_min_text" class="d-inline-block"></div>
                        <div class="d-inline-block"><div id="sonar__palette"></div></div>
                        <div id="sonar__palette_max_text" class="d-inline-block"></div>

                        <input id="sonar__over_bottom" type="checkbox" checked> over bottom  &nbsp;&nbsp;&nbsp;&nbsp;
                        <input id="sonar__bottom" type="checkbox" checked> bottom

                    </div>   
                    <div id="sonar__3D_block"></div>
                </div>                
            </div>


            <script>
                let sonar__depth_min = 0;
                let sonar__depth_max = 0;
                let depth_min_allow = 0;
                let depth_max_allow = 0;
                let sonar__dataItemsCount = 0;
                const sonar__colors = [
                    '#f51c03',
                    '#f45202',
                    '#f38802',
                    '#f2be01',
                    '#f1f501',
                    '#bde708',
                    '#89da0f',
                    '#55cd16',
                    '#21c01d',
                    '#20ad31',
                    '#1f9a45',
                    '#1e8759',
                    '#00d9ff',
                    '#109df5',
                    '#2061ec',
                    '#3125e3'
                ];
                let sonar__lat_min = 1000, sonar__lng_min = 1000, sonar__lat_max = 0, sonar__lng_max = 0;
                let sonar__getOffsetLng_px_dx = 0;
                const sonar__block_size_px = 800;

                document.addEventListener('DOMContentLoaded', function () {
                    sonar__palette();
                    sonar__actions();
                });

                function sonar__actions() {
                    $('#form_bathymetry__btn_ok').click(() => {
                        sonar__bathymetryProcess();
                    });
                    $('#sonar__over_bottom').change(() => {
                        if ($('#sonar__over_bottom').is(":checked")) {
                            $('.logic_pulses_block').show();
                        } else {
                            $('.logic_pulses_block').hide();
                        }
                    });
                    $('#sonar__bottom').change(() => {
                        if ($('#sonar__bottom').is(":checked")) {
                            $('.logic_pulses_full_block').show();
                        } else {
                            $('.logic_pulses_full_block').hide();
                        }
                    });
                }

                function sonar__getPulse_w_realBottom_mks_min(depth_mks) {
                    if (depth_mks < 1500) {
                        return 1200;
                    }
                    if (depth_mks < 3000) {
                        return 3000;
                    }
                    return 3200;
                }

                function sonar__bathymetryProcess() {
                    let sonar__pointsLatLng = [];
                    sonar__depth_min = 0;
                    sonar__depth_max = 0;
                    depth_min_allow = parseFloat($('#form_bathymetry__depth_min_input').val()) || 0;
                    depth_max_allow = parseFloat($('#form_bathymetry__depth_max_input').val()) || 0;


                    const lines = $('#form_bathymetry__data_input').val().split(/\n/);
                    for (const line of lines) {
                        let pulses = [];
                        let RR = [], FF = [];
                        const raw = line.split(';');

                        for (var i = 1; i <= 16; i++) {
                            const mks = parseInt(raw[i]) || 0;
                            if (mks > 0) {
                                RR.push(mks);
                            }
                        }
                        for (var i = 18; i <= 33; i++) {
                            const mks = parseInt(raw[i]) || 0;
                            if (mks > 0) {
                                FF.push(mks);
                            }
                        }
                        if (RR.length <= 0) {
                            continue; //goto next line
                        }

                        for (const R of RR) {
                            for (const F of FF) {
                                if (R < F) {
                                    w_mks = F - R;
                                    const pulse = {
                                        R: R,
                                        F: F,
                                        W: (F - R)
                                    };
                                    pulses.push(pulse);
                                    break;
                                }
                            }
                        }

                        let depth_mks = 0;
                        for (const pulse of pulses) {
                            const pulse_w_realBottom_mks_min = sonar__getPulse_w_realBottom_mks_min(pulse.R);
                            if (pulse.W >= pulse_w_realBottom_mks_min) {
                                depth_mks = pulse.R;
                            }
                        }

                        //3D
                        const lat = parseFloat(raw[34]) || 0;
                        const lng = parseFloat(raw[35]) || 0;
                        let depthM = depth_mks / 1367.0;
                        if (lat > 0 && lng > 0 && depthM >= depth_min_allow && depthM <= depth_max_allow) {
                            const lat5 = Math.round(lat * 100000) / 100000;
                            const lng5 = Math.round(lng * 100000) / 100000;
                            const idx = lat5 + '_' + lng5;

                            let point = {
                                depthM: depthM,
                                depth_mks: depth_mks,
                                pulses: pulses
                            };
                            if (sonar__pointsLatLng[idx] > 0) {
                                depthM = (sonar__pointsLatLng[idx].depthM + depthM) / 2.0;
                            }
                            sonar__pointsLatLng[idx] = point;

                            if (sonar__depth_min > depthM) {
                                sonar__depth_min = depthM;
                            }
                            if (sonar__depth_max < depthM) {
                                sonar__depth_max = depthM;
                            }

                            if (sonar__lat_min > lat) {
                                sonar__lat_min = lat;
                            }
                            if (sonar__lng_min > lng) {
                                sonar__lng_min = lng;
                            }
                            if (sonar__lat_max < lat) {
                                sonar__lat_max = lat;
                            }
                            if (sonar__lng_max < lng) {
                                sonar__lng_max = lng;
                            }

                            sonar__dataItemsCount++;
                        }
                    } // one line

                    //all lines processed
                    $('#bathymetry__points_count').html(sonar__dataItemsCount + ' points');
                    $('#sonar__palette_min_text').html(Math.round(sonar__depth_min * 100) / 100 + ' m');
                    $('#sonar__palette_max_text').html(Math.round(sonar__depth_max * 100) / 100 + ' m');


                    sonar__getOffsetLng_px_dx = (sonar__lng_max - sonar__lng_min) / sonar__block_size_px;

                    for (let index in sonar__pointsLatLng) {
                        const ll = index.split(/_/);
                        sonar__point(ll[0], ll[1], sonar__pointsLatLng[index]);
                    }
                }

                function sonar__palette() {
                    for (const color of sonar__colors) {
                        const dv = '<div class="palette__item d-inline-block" style="background-color:' + color + '"></div>';
                        $('#sonar__palette').append(dv);
                    }
                }

                function sonar__point(lat, lng, data) {
                    const color = sonar__getColor(data.depthM);
                    const left_px = sonar__getOffsetLng_px(lng);
                    const top_px = sonar__block_size_px - sonar__getOffsetLat_px(lat);
                    const w_px = Math.round(0.00001 / sonar__getOffsetLng_px_dx);

                    let html = '<div class="logic_pulses_block" style="left:' + left_px + 'px; top:' + top_px + 'px; border-bottom-color:' + color + '; width:' + w_px + 'px; ">';
                    for (const pulse of data.pulses) {
                        if (pulse.R >= (data.depth_mks - 100)) {
                            break; //only fish over bottom                            
                        }
                        let mt_px = sonar__getDepth_px(pulse.R);
                        let h_px = Math.max(sonar__getDepth_px(pulse.W + pulse.R) - mt_px, 2);
                        html += '<div class="logic_pulse" style="top:' + mt_px + 'px; height:' + h_px + 'px; width:' + (w_px - 2) + 'px; "></div>';
                    }
                    html += '</div>';

                    html += '<div class="logic_pulses_full_block" style="left:' + left_px + 'px; top:' + top_px + 'px; border-bottom-color:' + color + '; width:' + w_px + 'px; ">';
                    for (const pulse of data.pulses) {
                        if (pulse.R >= (data.depth_mks - 100)) {
                            pulse_color = color; //bottom
                        } else {
                            pulse_color = 'grey'; //fish UNDER bottom
                        }
                        let mt_px = sonar__getDepth_px(pulse.R);
                        let h_px = Math.max(sonar__getDepth_px(pulse.W + pulse.R) - mt_px, 2);
                        html += '<div class="logic_pulse_full" style="top:' + mt_px + 'px; height:' + h_px + 'px; width:' + (w_px - 2) + 'px; background-color:' + pulse_color + '; "></div>';
                    }
                    html += '</div>';

                    $('#sonar__3D_block').append(html);
                }

                function sonar__getColor(m) {
                    const dx = (sonar__depth_max - sonar__depth_min) / sonar__colors.length;
                    let idx = Math.round(m / dx);
                    idx = Math.min(Math.max(parseInt(idx), 0), (sonar__colors.length - 1)); //constrain from to
                    return sonar__colors[idx];
                }

                function sonar__getDepth_px(mks) {
                    //const dx = (sonar__depth_max - sonar__depth_min) / 100; //height 
                    const dx = (2 * depth_max_allow * 1367.0) / 100; //height 
                    let px = Math.round(mks / dx);
                    px = Math.min(Math.max(px, 0), 100); //constrain from to
                    return px;
                }

                function sonar__getOffsetLat_px(lat) {
                    const dx = (sonar__lat_max - sonar__lat_min) / sonar__block_size_px; //max size paper
                    let px = Math.round((lat - sonar__lat_min) / dx);
                    return px;

                }
                function sonar__getOffsetLng_px(lng) {
                    let px = Math.round((lng - sonar__lng_min) / sonar__getOffsetLng_px_dx);
                    return px;
                }


            </script>
        </main>
        <script src="jquery-3.6.0.min.js"></script>
        <script src="bootstrap.bundle.min.js"></script>
    </body>
</html>
<style>
    .palette__item {
        width:20px; 
        height:30px; 
        margin: 0;
        padding: 0;
    }

    #sonar__3D_block{ 
        width: 100%; 
        height: 675px; 
        overflow: scroll;
        position: relative;
        border: 1px solid #003580;
        padding-top: 20px;
    }
    .logic_pulses_block{
        display: block;
        float: left;        
        height: 100px; /*see  sonar__getDepth_px*/
        border-bottom: 8px solid grey;         
        position: absolute;
        opacity: 0.4;
        z-index: 500;
        transform: rotate(20deg);
        padding: 0;
        margin: 0;
    }
    .logic_pulses_block:hover{
        border-left: 1px solid red;
        border-right: 1px solid red;
        border-top: 1px solid red;
        opacity: 1;
        background-color: white;
        z-index: 600;        
    }
    .logic_pulse{          
        background-color: grey;       
        position: absolute;    
        padding: 0;
        margin: 0;
    }  


    .logic_pulses_full_block{
        display: block;
        float: left;        
        height: 100px; /*see  sonar__getDepth_px*/
        border-bottom: 8px solid grey;         
        position: absolute;
        opacity: 0.4;
        z-index: 500;        
        padding: 0;
        margin: 0;
        transform: rotate(20deg);
    }
    .logic_pulses_full_block:hover{
        border-left: 1px solid red;
        border-right: 1px solid red;
        border-top: 1px solid red;
        opacity: 1;
        background-color: white;
        z-index: 600;       

    }
    .logic_pulse_full{          
        background-color: grey;       
        position: absolute;    
        padding: 0;
        margin: 0;
    }  
</style>
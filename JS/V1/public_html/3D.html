<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>My first three.js app</title>
        <style>
            body { margin: 0; }
        </style>
    </head>
    <body>
        <div id="container"></div>
        <script src="three.js"></script>
        <script>

            let container, stats;
            let camera, controls, scene, renderer;
            let mesh, texture;
            let plane, geometry;

            const worldWidth = 256, worldDepth = 256;

            init();


            function init() {
                container = document.getElementById('container');

                camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 0.1, 10000);

                scene = new THREE.Scene();
                //scene.background = new THREE.Color(0xefd1b5);
                //scene.fog = new THREE.FogExp2(0xefd1b5, 0.0025);



                camera.position.set(0, 0, 300);
                //camera.lookAt(0, 0, 300);
                //camera.position.z = 300;

                /*const data = generateHeight(worldWidth, worldDepth);
                 //const geometry = new THREE.PlaneGeometry(7500, 7500, worldWidth - 1, worldDepth - 1);
                 //geometry.rotateX(-Math.PI / 2);
                 const geometry = new THREE.PlaneGeometry(7500, 7500, worldWidth - 1, worldDepth - 1);
                 
                 const vertices = geometry.attributes.position.array;
                 for (let i = 0, j = 0, l = vertices.length; i < l; i++, j += 3) {
                 vertices[ j + 1 ] = data[ i ] * 10;
                 }
                 
                 texture = new THREE.CanvasTexture(generateTextureRGB(data, worldWidth, worldDepth));
                 texture.wrapS = THREE.ClampToEdgeWrapping;
                 texture.wrapT = THREE.ClampToEdgeWrapping;
                 
                 mesh = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({map: texture}));
                 scene.add(mesh); */




                renderer = new THREE.WebGLRenderer();
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(renderer.domElement);


            }


            function render() {
                renderer.render(scene, camera);
            }


            function animate() {
                requestAnimationFrame(animate);
                plane.rotation.x += 0.01;
                plane.rotation.y += 0.01;
                plane.rotation.z += 0.01;
                render();
            }


            var img = new Image();
            img.onload = function () {

                const loader = new THREE.TextureLoader();
                loader.load(
                        'zmap.png',
                        function (texture) {
                            const material = new THREE.MeshBasicMaterial({
                                map: texture
                            });
                            var data = getHeightData(img);
                            texture.wrapS = THREE.ClampToEdgeWrapping;
                            texture.wrapT = THREE.ClampToEdgeWrapping;
                            geometry = new THREE.PlaneGeometry(worldWidth, worldDepth, worldWidth - 1, worldDepth - 1);
                            //geometry.rotateX(-Math.PI / 2);
                            //geometry.rotateY(-Math.PI / 2);
                            //material = new THREE.MeshBasicMaterial({color: 0xffff00, side: THREE.DoubleSide});
                            const vertices = geometry.attributes.position.array;
                            for (let i = 0, j = 4, l = vertices.length; i < l; i++, j += 3) {
                                //vertices[ j +1 ] = data[i]*2;
                                geometry.attributes.position.array[j+1]= data[i]/6;
                            }
                            //geometry.computeVertexNormals();
                            plane = new THREE.Mesh(geometry, material);
                           

                            scene.add(plane);

                            animate();
                        },
                        undefined,
                        function (err) {
                            console.error('An error happened.');
                        }
                );





            };
            img.src = "zmap.png";

            function getHeightData(img, scale) {

                if (scale == undefined) {
                    scale = 1;
                }

                var canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                var context = canvas.getContext('2d');

                var size = img.width * img.height;
                var data = new Float32Array(size);

                context.drawImage(img, 0, 0);

                for (var i = 0; i < size; i++) {
                    data[i] = 0;
                }

                var data = canvas.getContext('2d').getImageData(0, 0, img.width, img.height).data;

                var normPixels = [];

                for (var i = 0, n = data.length; i < n; i += 4) {
                    // get the average value of R, G and B.
                    normPixels.push((data[i] + data[i + 1] + data[i + 2]) / 3);
                }

                return normPixels;
            }


        </script>
    </body>
</html>
<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        <title>Bathymetry</title>
    </head>
    <body>
        <main class="container">
            <div class="row">
                <div class="col">
                    <h2>
                        Bathymetry 
                        <span id="bathymetry__points_count"></span>
                    </h2>
                    <div class="row">                        
                        <div class="col-auto">
                            <div class="" style="width: 170px">
                                <div class="input-group">
                                    <span class="input-group-text" id="basic-addon1">Min depth, m</span>
                                    <input type="number" id="form_bathymetry__depth_min_input" placeholder="min" value="1" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="" style="width: 110px">
                                <div class="input-group">
                                    <span class="input-group-text" id="basic-addon1">max</span>
                                    <input type="number" id="form_bathymetry__depth_max_input" placeholder="max" value="5" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <textarea id="form_bathymetry__data_input" class="form-control" style="width: 200px; height: 16px;" placeholder="Logic log"></textarea> 
                        </div>
                        <div class="col-auto">
                            <span id="form_bathymetry__btn_ok" class="btn btn-success">Ok</span>
                        </div>
                    </div>   
                </div>                
            </div>
            <div class="row">
                <div class="col-12 mt-2">
                    <div id="map__logic_block"></div>
                </div>
                <div class="col-12 mt-2 bm-4">
                    <div class="d-block">
                        <div id="map_palette_min_text" class="d-inline-block"></div>
                        <div class="d-inline-block"><div id="map_palette"></div></div>
                        <div id="map_palette_max_text" class="d-inline-block"></div>
                    </div>
                    <div id="map__bathymetry_block" style="width: 100%; height: 500px; margin: 4px 0px;"></div>
                </div>
            </div>

            <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=ea0860a1-d606-43c4-88f4-93529deb4edb" type="text/javascript"></script>
            <script>
                let map__map;
                let map__mapIsReady = false;
                let map__depth_min = 0;
                let map__depth_max = 0;
                let map__dataItemsCount = 0;
                const map__colors = [
                    '#f51c03',
                    '#f45202',
                    '#f38802',
                    '#f2be01',
                    '#f1f501',
                    '#bde708',
                    '#89da0f',
                    '#55cd16',
                    '#21c01d',
                    '#20ad31',
                    '#1f9a45',
                    '#1e8759',
                    '#00d9ff',
                    '#109df5',
                    '#2061ec',
                    '#3125e3'
                ];

                document.addEventListener('DOMContentLoaded', function () {
                    ymaps.ready(map__init);
                    map__palette();
                    map__actions();
                });

                function map__render() {

                }

                function map__actions() {
                    $('#form_bathymetry__btn_ok').click(() => {
                        map__bathymetryProcess();
                    });
                }

                function map__getPulse_w_realBottom_mks_min(depth_mks) {
                    if (depth_mks < 1500) {
                        return 1200;
                    }
                    if (depth_mks < 3000) {
                        return 3000;
                    }
                    return 3200;
                }

                function map__bathymetryProcess() {
                    let map__pointsLatLng = [];
                    map__depth_min = 0;
                    map__depth_max = 0;
                    const depth_min_allow = parseFloat($('#form_bathymetry__depth_min_input').val()) || 0;
                    const depth_max_allow = parseFloat($('#form_bathymetry__depth_max_input').val()) || 0;
                    //let lat_min = 0, lng_min = 0, lat_max = 0, lng_max = 0;

                    const lines = $('#form_bathymetry__data_input').val().split(/\n/);
                    for (const line of lines) {
                        let pulses = [];
                        let RR = [], FF = [];
                        const raw = line.split(';');

                        for (var i = 1; i <= 16; i++) {
                            const mks = parseInt(raw[i]) || 0;
                            if (mks > 0) {
                                RR.push(mks);
                            }
                        }
                        for (var i = 18; i <= 33; i++) {
                            const mks = parseInt(raw[i]) || 0;
                            if (mks > 0) {
                                FF.push(mks);
                            }
                        }
                        if (RR.length <= 0) {
                            continue; //goto next line
                        }

                        for (const R of RR) {
                            for (const F of FF) {
                                if (R < F) {
                                    w_mks = F - R;
                                    const pulse = {
                                        R: R,
                                        F: F,
                                        W: (F - R)
                                    };
                                    pulses.push(pulse);
                                    break;
                                }
                            }
                        }

                        let depth_mks = 0;
                        for (const pulse of pulses) {
                            const pulse_w_realBottom_mks_min = map__getPulse_w_realBottom_mks_min(pulse.R);
                            if (pulse.W >= pulse_w_realBottom_mks_min) {
                                depth_mks = pulse.R;
                            }
                        }


                        //MAP
                        const lat = parseFloat(raw[34]) || 0;
                        const lng = parseFloat(raw[35]) || 0;
                        let depthM = depth_mks / 1367.0;
                        if (lat > 0 && lng > 0 && depthM >= depth_min_allow && depthM <= depth_max_allow) {
                            const lat5 = Math.round(lat * 100000) / 100000;
                            const lng5 = Math.round(lng * 100000) / 100000;
                            const idx = lat5 + '_' + lng5;
                            if (map__pointsLatLng[idx] > 0) {
                                depthM = (map__pointsLatLng[idx] + depthM) / 2.0;
                            }
                            map__pointsLatLng[idx] = depthM;

                            if (map__depth_min > depthM) {
                                map__depth_min = depthM;
                            }
                            if (map__depth_max < depthM) {
                                map__depth_max = depthM;
                            }
                            
                            map__dataItemsCount++;
                        }

                        //LOGIC
                        if (map__dataItemsCount < 500) {
                            let html = '<div class="logic_pulses_block">';
                            let lastF = 0;
                            for (const pulse of pulses) {
                                let ml_px = Math.round((pulse.R) / 10.0);
                                let w_px = Math.round(pulse.W / 10.0);
                                html += '<div class="logic_pulse" title="W,mks: ' + pulse.W + '" style="margin-left:' + ml_px + 'px; width:' + w_px + 'px;"></div>';
                                html += '<div class="logic_pulse_axis_x_point" title="mks from Sync: ' + pulse.R + '" style="margin-left:' + (ml_px - 4) + 'px; "></div>';
                                html += '<div class="logic_pulse_axis_x_point" title="mks from Sync: ' + pulse.F + '" style="margin-left:' + (ml_px + w_px - 4) + 'px; "></div>';
                                lastF = pulse.F;
                            }
                            html += '<div class="logic_pulse_axis_x" style="margin-left:0px; width:' + lastF + 'px;"></div>';
                            html += '</div>';
                            $('#map__logic_block').append(html);
                        }

                        
                    }

                    if (map__mapIsReady) {
                        for (let index in map__pointsLatLng) {
                            const ll = index.split(/_/);
                            map__point(ll[0], ll[1], map__pointsLatLng[index]);
                        }
                    }

                    $('#bathymetry__points_count').html(map__dataItemsCount + ' points');
                    $('#map_palette_min_text').html(Math.round(map__depth_min * 100) / 100 + ' m');
                    $('#map_palette_max_text').html(Math.round(map__depth_max * 100) / 100 + ' m');
                }

                function map__palette() {
                    for (const color of map__colors) {
                        const dv = '<div class="palette__item d-inline-block" style="background-color:' + color + '"></div>';
                        $('#map_palette').append(dv);
                    }
                }

                /*const map_onReady_promise = new Promise((resolve, reject) => {
                 const timerId = setInterval(function () {
                 if (map__mapIsReady) {
                 clearInterval(timerId);
                 resolve();
                 }
                 }, 1000);
                 });
                 
                 map_onReady_promise.then(map__render);*/

                function map__init() {
                    /* ymaps.geolocation.get().then(function (res) {
                     var mapContainer = $('#map__bathymetry_block'),
                     bounds = res.geoObjects.get(0).properties.get('boundedBy'),
                     // Рассчитываем видимую область для текущей положения пользователя.
                     mapState = ymaps.util.bounds.getCenterAndZoom(
                     bounds,
                     [mapContainer.width(), mapContainer.height()]
                     );
                     mapState.zoom = 11;
                     map__createMap(mapState);  
                     }, function (e) {
                     // Если местоположение невозможно получить, то просто создаем карту.
                     map__createMap({
                     center: [57, 39],
                     zoom: 11
                     });
                     });*/

                    map__createMap({
                        center: [57, 39],  //TODO center to points
                        zoom: 18
                    });
                }

                function map__createMap(state) {
                    map__map = new ymaps.Map('map__bathymetry_block', state);
                    map__mapIsReady = true;
                }



                function map__point(lat, lng, depthM) {
                    const color = map__getColor(depthM) + 'FF';
                    let r = 1;
                    let myCircle = new ymaps.Circle([
                        [lat, lng], // Координаты центра круга.            
                        r // Радиус круга в метрах.
                    ], {
                        balloonContent: Math.round(depthM * 100) / 100 + "m",
                        hintContent: Math.round(depthM * 100) / 100 + "m",
                    }, {
                        draggable: false,
                        fillColor: color, // Цвет заливки. Последний байт (77) определяет прозрачность.            
                        strokeColor: color, // Цвет обводки.            
                        strokeOpacity: 0, // Прозрачность обводки.           
                        strokeWidth: 1 // Ширина обводки в пикселях.
                    });
                    map__map.geoObjects.add(myCircle);
                }

                function map__getColor(depthM) {
                    const dx = (map__depth_max - map__depth_min) / map__colors.length;
                    let idx = Math.round(depthM / dx);
                    idx = Math.min(Math.max(parseInt(idx), 0), (map__colors.length - 1)); //constrain from to
                    return map__colors[idx];
                }

            </script>
        </main>
        <script
            src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
        crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    </body>
</html>
<style>
    .palette__item {
        width:20px; 
        height:30px; 
        margin: 0;
        padding: 0;
    }

    #map__logic_block{ 
        width: 100%; 
        height: 400px; 
        overflow: scroll;
        position: relative;
        border: 1px solid #003580;
        padding-top: 20px;
    }
    .logic_pulses_block{
        display: block;
        float: left;
        width: 100%;
        height: 50px;
    }
    .logic_pulse{
        height: 14px;
        background-color: #003580;
        display: inline-block;
        position: absolute;
    }
    .logic_pulse:hover{         
        background-color: blueviolet;
    }
    .logic_pulse_axis_x{
        height: 1px;
        margin-top:13px;
        background-color: #003580;
        display: inline-block;
        position: absolute;
    }
    .logic_pulse_axis_x_point{
        height: 8px;
        width: 8px;
        border-radius: 4px;
        margin-top: 18px;
        background-color: gray;
        display: inline-block;
        position: absolute;
    }
    .logic_pulse_axis_x_point:hover{
        background-color: red;
    }
</style>